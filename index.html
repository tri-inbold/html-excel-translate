<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inbold Menu</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary: #667eea;
            --primary-dark: #5a67d8;
            --primary-light: #7c8aed;
            --secondary: #4299e1;
            --accent: #ed64a6;
            --success: #48bb78;
            --warning: #ed8936;
            --error: #f56565;
            --dark-bg: #0f172a;
            --card-bg: #1e293b;
            --card-hover: #334155;
            --border: #334155;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.15);
            --shadow-lg: 0 4px 16px rgba(0, 0, 0, 0.2);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Roboto', 'Arial', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--dark-bg);
            color: var(--text);
            line-height: 1.5;
            font-size: 14px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        #app {
            max-width: 900px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding-bottom: 100px;
        }
        
        @media (min-width: 769px) {
            #app {
                padding: 1.5rem;
                padding-top: 90px;
            }
            
            body {
                font-size: 13px;
            }
        }
        
        /* Main Content */
        main {
            flex-grow: 1;
            padding: 1.5rem 1rem 0;
        }
        
        @media (min-width: 769px) {
            main {
                padding: 1.5rem 1.5rem 0;
            }
        }
        
        .card {
            background: var(--card-bg);
            border-radius: var(--radius-md);
            padding: 1.25rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
        }
        
        @media (min-width: 769px) {
            .card {
                padding: 1.5rem;
            }
        }
        
        .card:hover {
            box-shadow: var(--shadow-md);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
        }
        
        @media (min-width: 769px) {
            .card-title {
                font-size: 20px;
            }
        }
        
        /* Hero Section */
        .hero-card {
            background: var(--gradient-1);
            position: relative;
            overflow: hidden;
            min-height: 160px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        
        @media (min-width: 769px) {
            .hero-card {
                min-height: 180px;
            }
        }
        
        .hero-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.08) 0%, transparent 70%);
            animation: pulse 4s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.05); opacity: 0.7; }
        }
        
        .hero-content {
            position: relative;
            z-index: 1;
        }
        
        .hero-greeting {
            font-size: 14px;
            font-weight: 400;
            margin-bottom: 6px;
            opacity: 0.95;
        }
        
        .hero-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        @media (min-width: 769px) {
            .hero-greeting {
                font-size: 15px;
            }
            
            .hero-title {
                font-size: 36px;
            }
        }
        
        .hero-subtitle {
            font-size: 13px;
            opacity: 0.9;
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
        }
        
        .stat-card {
            background: var(--card-bg);
            padding: 1rem;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            transition: all 0.2s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }
        
        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-bottom: 0.75rem;
        }
        
        .stat-icon.purple { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .stat-icon.blue { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .stat-icon.pink { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .stat-icon.green { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 2px;
        }
        
        .stat-label {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 1rem;
            overflow-x: auto;
            padding-bottom: 4px;
        }
        
        .tabs::-webkit-scrollbar {
            height: 3px;
        }
        
        .tabs::-webkit-scrollbar-track {
            background: var(--card-bg);
        }
        
        .tabs::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 2px;
        }
        
        .tab-btn {
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            font-weight: 500;
            font-size: 13px;
        }
        
        .tab-btn:hover {
            background: var(--card-hover);
            color: var(--text);
        }
        
        .tab-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        
        /* Food Options */
        .food-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.75rem;
        }
        
        .food-option {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            position: relative;
        }
        
        .food-option:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }
        
        .food-option.selected {
            border-color: var(--primary);
            background: rgba(102, 126, 234, 0.08);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .food-icon {
            font-size: 36px;
            margin-bottom: 8px;
        }
        
        .food-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text);
        }
        
        .food-day {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }
        
        /* Order Day Card */
        .order-day-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 1rem;
            margin-bottom: 0.75rem;
        }
        
        .order-day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        
        .order-day-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary);
        }
        
        .order-dish-list {
            display: grid;
            gap: 0.5rem;
        }
        
        .order-dish-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: rgba(102, 126, 234, 0.05);
            border-radius: var(--radius-sm);
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .order-dish-item:hover {
            border-color: var(--primary);
            background: rgba(102, 126, 234, 0.08);
        }
        
        .order-dish-item.selected {
            border-color: var(--primary);
            background: rgba(102, 126, 234, 0.12);
        }
        
        .order-dish-icon {
            font-size: 24px;
        }
        
        .order-dish-name {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
        }
        
        /* Staff List */
        .staff-list {
            list-style: none;
        }
        
        .staff-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            background: rgba(30, 41, 59, 0.5);
            border-radius: var(--radius-sm);
            margin-bottom: 6px;
            border: 1px solid transparent;
            transition: all 0.2s ease;
        }
        
        .staff-item:hover {
            background: var(--card-hover);
            border-color: var(--border);
        }
        
        .staff-item.eaten {
            opacity: 0.5;
        }
        
        .staff-details {
            flex: 1;
        }
        
        .staff-name {
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 2px;
        }
        
        .staff-dish {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        .staff-email {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        /* Profile Section */
        .profile-section {
            text-align: center;
            padding: 2rem 1rem;
        }
        
        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid var(--primary);
            margin: 0 auto 1rem;
            object-fit: cover;
        }
        
        .profile-name {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .profile-depart {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 2rem;
        }
        
        .profile-language-toggle {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin-bottom: 1.5rem;
        }
        
        .profile-language-toggle button {
            padding: 0.5rem 1.5rem;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--card-bg);
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            font-size: 13px;
        }
        
        .profile-language-toggle button.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        
        .profile-menu {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .profile-menu-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .profile-menu-item:hover {
            background: var(--card-hover);
            border-color: var(--primary);
        }
        
        .profile-menu-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
        }
        
        .profile-menu-icon.green {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        
        .profile-menu-icon.red {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .profile-menu-text {
            flex: 1;
            text-align: left;
        }
        
        .profile-menu-label {
            font-size: 14px;
            font-weight: 500;
        }
        
        .profile-menu-value {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        /* Buttons */
        .btn {
            padding: 10px 20px;
            border-radius: var(--radius-sm);
            border: none;
            font-weight: 500;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .btn-primary {
            background: var(--gradient-1);
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: var(--card-bg);
            color: var(--text);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: var(--card-hover);
        }
        
        .btn-danger {
            background: var(--error);
            color: white;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-block {
            width: 100%;
        }
        
        .icon-btn {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-sm);
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 16px;
        }
        
        .icon-btn:hover {
            background: var(--card-hover);
            transform: translateY(-1px);
        }
        
        .icon-btn.active {
            background: var(--primary);
            border-color: var(--primary);
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 13px;
            color: var(--text);
        }
        
        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 10px 12px;
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-size: 13px;
            transition: all 0.2s ease;
            font-family: 'Roboto', 'Arial', sans-serif;
        }
        
        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        /* Search Bar */
        .search-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 1rem;
        }
        
        .search-input {
            flex: 1;
            padding: 10px 12px;
            padding-left: 38px;
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-size: 13px;
        }
        
        .search-wrapper {
            position: relative;
            flex: 1;
        }
        
        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 14px;
        }
        
        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }
        
        .modal-content {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            width: 100%;
            max-width: 450px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
            animation: modalSlideIn 0.2s ease;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .close-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .close-btn:hover {
            background: var(--card-hover);
            color: var(--text);
        }
        
        /* Bottom Navigation */
        #tab-bar {
            position: fixed;
            bottom: 0.75rem;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(30, 41, 59, 0.98);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 6px;
            display: flex;
            gap: 4px;
            box-shadow: var(--shadow-lg);
            z-index: 100;
            width: calc(100% - 1.5rem);
            max-width: 500px;
        }
        
        @media (min-width: 769px) {
            #tab-bar {
                top: 1rem;
                bottom: auto;
                border-radius: 24px;
                padding: 8px;
                max-width: 600px;
            }
        }
        
        .nav-item {
            flex: 1;
            padding: 10px 12px;
            border-radius: 14px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            font-size: 11px;
            font-weight: 500;
            position: relative;
        }
        
        .nav-item i {
            font-size: 18px;
        }
        
        .nav-item img {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid transparent;
        }
        
        .nav-item:hover {
            color: var(--text);
        }
        
        .nav-item.active {
            background: var(--primary);
            color: white;
        }
        
        .nav-item.active img {
            border-color: white;
        }
        
        .nav-item.needs-attention::after {
            content: '';
            position: absolute;
            top: 6px;
            right: 16px;
            width: 6px;
            height: 6px;
            background: var(--error);
            border-radius: 50%;
            animation: pulse-dot 1.5s infinite;
        }
        
        @keyframes pulse-dot {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(245, 101, 101, 0.7);
            }
            50% {
                box-shadow: 0 0 0 5px rgba(245, 101, 101, 0);
            }
        }
        
        /* Toast */
        #toast-notification {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(150px);
            background: var(--card-bg);
            color: var(--text);
            padding: 12px 20px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
            z-index: 1001;
            transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            max-width: 90%;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
        }
        
        #toast-notification.show {
            transform: translateX(-50%) translateY(0);
        }
        
        #toast-notification.success {
            border-color: var(--success);
        }
        
        #toast-notification.error {
            border-color: var(--error);
        }
        
        .toast-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
        }
        
        .toast-icon.success {
            background: var(--success);
        }
        
        .toast-icon.error {
            background: var(--error);
        }
        
        /* Loader */
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid rgba(102, 126, 234, 0.2);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Table */
        .table-wrapper {
            overflow-x: auto;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: rgba(102, 126, 234, 0.08);
        }
        
        th {
            padding: 10px 12px;
            text-align: left;
            font-weight: 600;
            color: var(--primary);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        td {
            padding: 10px 12px;
            border-top: 1px solid var(--border);
            font-size: 13px;
        }
        
        tr:hover {
            background: rgba(102, 126, 234, 0.04);
        }
        
        .action-buttons {
            display: flex;
            gap: 6px;
        }
        
        /* Shift Toggle */
        .shift-toggle {
            display: flex;
            gap: 6px;
            background: rgba(102, 126, 234, 0.08);
            padding: 4px;
            border-radius: var(--radius-sm);
        }
        
        .shift-toggle input[type="radio"] {
            display: none;
        }
        
        .shift-toggle label {
            flex: 1;
            padding: 8px 14px;
            text-align: center;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            color: var(--text-muted);
            font-size: 13px;
        }
        
        .shift-toggle input[type="radio"]:checked + label {
            background: var(--primary);
            color: white;
        }
        
        /* Day Selector */
        .day-selector {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 6px;
            margin-bottom: 1rem;
        }
        
        .day-selector input[type="checkbox"] {
            display: none;
        }
        
        .day-selector label {
            padding: 8px;
            text-align: center;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            color: var(--text-muted);
            font-size: 12px;
            background: var(--card-bg);
        }
        
        .day-selector input[type="checkbox"]:checked + label {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        
        /* Menu Item */
        .menu-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            margin-bottom: 0.5rem;
        }
        
        .menu-item-icon {
            font-size: 24px;
        }
        
        .menu-item-text {
            flex: 1;
            font-size: 14px;
        }
        
        /* Utilities */
        .hidden {
            display: none !important;
        }
        
        .text-center {
            text-align: center;
        }
        
        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mt-3 { margin-top: 1.5rem; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-3 { margin-bottom: 1.5rem; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .hero-title {
                font-size: 28px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .food-options {
                grid-template-columns: 1fr;
            }
            
            .nav-item span {
                display: none;
            }
            
            .hide-mobile {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <main id="main-content"></main>
        
        <!-- Modals -->
        <div id="language-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Ch·ªçn ng√¥n ng·ªØ</h2>
                    <button id="close-language-btn" class="close-btn"><i class="fas fa-times"></i></button>
                </div>
                <div class="form-group">
                    <div class="shift-toggle">
                        <input type="radio" id="lang-vi" name="language" value="vi" checked>
                        <label for="lang-vi">Ti·∫øng Vi·ªát</label>
                        <input type="radio" id="lang-en" name="language" value="en">
                        <label for="lang-en">English</label>
                    </div>
                </div>
                <button id="save-language-btn" class="btn btn-primary btn-block">L∆∞u</button>
            </div>
        </div>
        
        <div id="personnel-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="personnel-modal-title" class="modal-title">Th√™m nh√¢n vi√™n</h2>
                    <button id="close-personnel-modal-btn" class="close-btn"><i class="fas fa-times"></i></button>
                </div>
                <input type="hidden" id="personnel-original-email-key">
                <div class="form-group">
                    <label class="form-label">T√™n</label>
                    <input type="text" id="personnel-name-input" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="personnel-email-input" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Ph√≤ng ban</label>
                    <select id="personnel-depart-select" class="form-select"></select>
                </div>
                <button id="save-personnel-btn" class="btn btn-primary btn-block">L∆∞u</button>
            </div>
        </div>
        
        <div id="guest-order-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">ƒê·∫∑t m√≥n cho kh√°ch</h2>
                    <button id="close-guest-order-modal-btn" class="close-btn"><i class="fas fa-times"></i></button>
                </div>
                <div class="form-group">
                    <label class="form-label">T√™n kh√°ch</label>
                    <input type="text" id="guest-name-input" class="form-input" placeholder="Nh·∫≠p t√™n kh√°ch">
                </div>
                <div class="form-group">
                    <label class="form-label">Ph√≤ng ban/C√¥ng ty</label>
                    <input type="text" id="guest-depart-input" class="form-input" placeholder="Nh·∫≠p t√™n c√¥ng ty">
                </div>
                <div class="form-group">
                    <label class="form-label">Ca ƒÉn</label>
                    <div class="shift-toggle">
                        <input type="radio" id="guest-shift-m" name="guest-shift" value="M" checked>
                        <label for="guest-shift-m">Ca s√°ng</label>
                        <input type="radio" id="guest-shift-e" name="guest-shift" value="E">
                        <label for="guest-shift-e">Ca chi·ªÅu</label>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Tu·∫ßn</label>
                    <div class="shift-toggle">
                        <input type="radio" id="guest-week-this" name="guest-week" value="this" checked>
                        <label for="guest-week-this">Tu·∫ßn n√†y</label>
                        <input type="radio" id="guest-week-next" name="guest-week" value="next">
                        <label for="guest-week-next">Tu·∫ßn sau</label>
                    </div>
                </div>
                <div id="guest-order-days-container"></div>
                <button id="save-guest-order-btn" class="btn btn-primary btn-block mt-3">Ho√†n t·∫•t</button>
            </div>
        </div>
        
        <div id="reopen-order-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="reopen-order-modal-title" class="modal-title"></h2>
                    <button id="close-reopen-order-modal-btn" class="close-btn"><i class="fas fa-times"></i></button>
                </div>
                <p style="color: var(--text-muted); margin-bottom: 1.5rem;">Thao t√°c n√†y s·∫Ω x√≥a m·ªçi d·ªØ li·ªáu ƒë·∫∑t m√≥n c·ªßa ng∆∞·ªùi n√†y trong tu·∫ßn, cho ph√©p h·ªç ƒë·∫∑t l·∫°i. B·∫°n c√≥ ch·∫Øc ch·∫Øn?</p>
                <button id="confirm-reopen-order-btn" class="btn btn-danger btn-block">X√°c nh·∫≠n M·ªü l·∫°i</button>
            </div>
        </div>
        
        <div id="delete-personnel-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">X√≥a nh√¢n vi√™n</h2>
                    <button id="close-delete-personnel-modal-btn" class="close-btn"><i class="fas fa-times"></i></button>
                </div>
                <p id="delete-personnel-text" style="color: var(--text-muted); margin-bottom: 1.5rem;"></p>
                <div style="display: flex; gap: 12px;">
                    <button id="cancel-delete-personnel-btn" class="btn btn-secondary" style="flex: 1;">H·ªßy</button>
                    <button id="confirm-delete-personnel-btn" class="btn btn-danger" style="flex: 1;">X√≥a</button>
                </div>
            </div>
        </div>

        <nav id="tab-bar" class="hidden"></nav>
        <div id="toast-notification"></div>
        <div id="loader" class="hidden"><div class="spinner"></div></div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteField } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, browserLocalPersistence, setPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCDrCaGUyr9xLkT-xOqzFd9grp6tN2u7Zo",
            authDomain: "hp-orders.firebaseapp.com",
            projectId: "hp-orders",
            storageBucket: "hp-orders.appspot.com",
            messagingSenderId: "616722831059",
            appId: "1:616722831059:web:9d19988d87397e7c13e626"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        
        const ADMIN_EMAILS = ['tri.vu.trong@inbold.com', 'truc.tran@inbold.com'];
        const FOOD_ICONS = ['üçú', 'üç≤', 'ü•ò', 'üçõ', 'üçù', 'ü•ó', 'üç±', 'üç£', 'ü•ô', 'üåÆ'];
        const SUPPORT_EMAIL = 'truc.tran@inbold.com';

        const elements = {
            mainContent: document.getElementById('main-content'),
            tabBar: document.getElementById('tab-bar'),
            loader: document.getElementById('loader'),
            languageModal: document.getElementById('language-modal'),
            personnelModal: document.getElementById('personnel-modal'),
            guestOrderModal: document.getElementById('guest-order-modal'),
            reopenOrderModal: document.getElementById('reopen-order-modal'),
            deletePersonnelModal: document.getElementById('delete-personnel-modal'),
            toast: document.getElementById('toast-notification'),
        };

        const state = {
            currentUser: null,
            staffProfile: null,
            isAdmin: false,
            currentTab: 'today',
            adminSubTab: 'support',
            authReady: false,
            menuFilterMode: 'auto',
            orderSelection: {},
            reopenTarget: { key: null, name: null },
            deleteTarget: { key: null, name: null },
            cachedData: new Map(),
            statsViewMode: 'day',
            statsViewDate: new Date(),
            guestOrderSelection: {},
        };

        // Utility Functions
        const getWeekString = (date) => {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            d.setDate(d.getDate() + 4 - (d.getDay() || 7));
            const yearStart = new Date(d.getFullYear(), 0, 1);
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return `${d.getFullYear()}_${weekNo}`;
        };

        const getDayKey = (date = new Date()) => ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][date.getDay()];
        const showLoader = () => elements.loader.classList.remove('hidden');
        const hideLoader = () => elements.loader.classList.add('hidden');
        const emailToKey = (email) => email.replace(/[.@]/g, '_');

        const parseDish = (dishString) => {
            if (!dishString) return '';
            const parts = dishString.split('|');
            const lang = state.staffProfile?.lan || 'vi';
            return (lang.startsWith('en') && parts.length > 1) ? parts[1].trim() : parts[0].trim();
        };

        const getFirstName = (fullName) => {
            if (!fullName) return '';
            const lang = state.staffProfile?.lan || 'vi';
            const parts = fullName.trim().split(' ');
            // For Vietnamese, last name is at the end
            if (lang.startsWith('vi')) {
                return parts[parts.length - 1];
            }
            // For English, first name is at the beginning
            return parts[0];
        };

        const showToast = (message, type = 'success') => {
            const iconMap = {
                success: '<i class="fas fa-check"></i>',
                error: '<i class="fas fa-times"></i>',
                info: '<i class="fas fa-info"></i>'
            };
            elements.toast.innerHTML = `
                <div class="toast-icon ${type}">${iconMap[type]}</div>
                <span>${message}</span>
            `;
            elements.toast.className = `show ${type}`;
            setTimeout(() => {
                elements.toast.classList.remove('show');
            }, 3000);
        };

        const getInitials = (name) => {
            return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
        };

        const getFoodIcon = (index) => {
            return FOOD_ICONS[index % FOOD_ICONS.length];
        };

        async function getDocument(collection, documentId, forceRefresh = false) {
            const cacheKey = `${collection}/${documentId}`;
            if (!forceRefresh && state.cachedData.has(cacheKey)) {
                return state.cachedData.get(cacheKey);
            }
            const docRef = doc(db, collection, documentId);
            const docSnap = await getDoc(docRef);
            const data = docSnap.exists() ? docSnap.data() : null;
            state.cachedData.set(cacheKey, data);
            return data;
        }

        async function render() {
            if (!state.authReady || !state.staffProfile) {
                hideLoader();
                return;
            }
            
            // Don't show loader for cached tabs
            const isCached = (state.currentTab === 'today' || state.currentTab === 'order') && 
                             state.cachedData.has('render_' + state.currentTab);
            
            if (!isCached) showLoader();
            
            try {
                switch (state.currentTab) {
                    case 'today':
                        await renderToday();
                        break;
                    case 'menu':
                        await renderMenu();
                        break;
                    case 'order':
                        await renderOrder();
                        break;
                    case 'profile':
                        await renderProfile();
                        break;
                    case 'admin':
                        await renderAdmin();
                        break;
                }
            } catch (error) {
                console.error('Render error:', error);
                elements.mainContent.innerHTML = `
                    <div class="card">
                        <p style="color: var(--error); text-align: center;">
                            <i class="fas fa-exclamation-circle"></i> 
                            C√≥ l·ªói x·∫£y ra khi t·∫£i d·ªØ li·ªáu.
                        </p>
                    </div>
                `;
            }
            hideLoader();
        }

        async function renderToday() {
            const dayKey = getDayKey();
            const firstName = getFirstName(state.staffProfile.name);
            
            if (['sun', 'sat'].includes(dayKey)) {
                const html = `
                    <div class="card hero-card">
                        <div class="hero-content">
                            <div class="hero-greeting">Ch√†o ${firstName} üëã</div>
                            <div class="hero-title">Cu·ªëi tu·∫ßn vui v·∫ª!</div>
                            <div class="hero-subtitle">H√¥m nay kh√¥ng ph·ª•c v·ª• b·ªØa ƒÉn</div>
                        </div>
                    </div>
                `;
                elements.mainContent.innerHTML = html;
                state.cachedData.set('render_today', html);
                return;
            }

            const weekString = getWeekString(new Date());
            const dayData = await getDocument(weekString, dayKey, false);
            const userEmailKey = emailToKey(state.currentUser.email);

            let html = '';
            if (dayData && dayData[userEmailKey]) {
                const userOrder = dayData[userEmailKey];
                const dishName = parseDish(userOrder.food);
                html = `
                    <div class="card hero-card">
                        <div class="hero-content">
                            <div class="hero-greeting">Ch√†o ${firstName} üëã</div>
                            <div class="hero-title">${dishName}</div>
                            <div class="hero-subtitle">H√¥m nay b·∫°n ƒÉn m√≥n n√†y</div>
                        </div>
                    </div>
                `;
            } else {
                html = `
                    <div class="card hero-card">
                        <div class="hero-content">
                            <div class="hero-greeting">Ch√†o ${firstName} üëã</div>
                            <div class="hero-title">Ch∆∞a c√≥ m√≥n</div>
                            <div class="hero-subtitle">B·∫°n ch∆∞a ƒë·∫∑t m√≥n cho h√¥m nay</div>
                        </div>
                    </div>
                `;
            }
            elements.mainContent.innerHTML = html;
            state.cachedData.set('render_today', html);
        }

        async function renderMenu() {
            const dayKey = getDayKey();
            const weekString = getWeekString(new Date());
            const dayData = await getDocument(weekString, dayKey, true);
            const userEmailKey = emailToKey(state.currentUser.email);
            
            // Check if user has ordered this week
            const monOrders = await getDocument(weekString, 'mon', true);
            const hasOrdered = monOrders && monOrders[userEmailKey];

            let content = `
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Danh s√°ch h√¥m nay</h2>
                        <button id="menu-filter-btn" class="icon-btn">
                            <i class="fas fa-filter"></i>
                        </button>
                    </div>
                    ${!hasOrdered ? `
                        <div style="margin-bottom: 1rem;">
                            <a href="mailto:${SUPPORT_EMAIL}" class="btn btn-secondary btn-block">
                                <i class="fas fa-headset"></i>
                                Ng∆∞·ªùi h·ªó tr·ª£
                            </a>
                        </div>
                    ` : ''}
                    <div class="search-bar">
                        <div class="search-wrapper">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" id="search-staff" class="search-input" placeholder="T√¨m ki·∫øm nh√¢n vi√™n...">
                        </div>
                    </div>
                    <div id="staff-list-container"></div>
                </div>
            `;

            elements.mainContent.innerHTML = content;

            if (dayData) {
                updateStaffListView(dayData);
                document.getElementById('search-staff').addEventListener('input', (e) => {
                    updateStaffListView(dayData, e.target.value);
                });
            } else {
                document.getElementById('staff-list-container').innerHTML = `
                    <p class="text-center" style="color: var(--text-muted); padding: 2rem;">
                        Ch∆∞a c√≥ d·ªØ li·ªáu cho h√¥m nay
                    </p>
                `;
            }
        }

        function updateStaffListView(dayData, searchTerm = '') {
            const container = document.getElementById('staff-list-container');
            const filterBtn = document.getElementById('menu-filter-btn');
            const hour = new Date().getHours();

            const staffOrders = Object.entries(dayData)
                .map(([emailKey, order]) => ({ emailKey, ...order }))
                .filter(o => o.name && o.name.toLowerCase().includes(searchTerm.toLowerCase()));

            filterBtn.innerHTML = state.menuFilterMode === 'auto' 
                ? `<i class="fas ${hour < 15 ? 'fa-sun' : 'fa-moon'}"></i>`
                : `<i class="fas fa-users"></i>`;

            const createListHTML = (list) => {
                return list
                    .sort((a, b) => (a.status === 'eaten' ? 1 : -1) || a.name.localeCompare(b.name))
                    .map(order => `
                        <li class="staff-item ${order.status === 'eaten' ? 'eaten' : ''}">
                            <div class="staff-details">
                                <div class="staff-name">${order.name}</div>
                                <div class="staff-dish">${parseDish(order.food)}</div>
                            </div>
                        </li>
                    `).join('');
            };

            const sang = staffOrders.filter(o => o.shift === 'M');
            const chieu = staffOrders.filter(o => o.shift === 'E');

            let html = '<ul class="staff-list">';
            
            if ((state.menuFilterMode === 'auto' && hour < 15) || state.menuFilterMode === 'all') {
                if (sang.length > 0) {
                    html += `<h3 style="color: var(--primary); padding: 1rem 0 0.5rem; font-size: 18px;">‚òÄÔ∏è Ca s√°ng</h3>${createListHTML(sang)}`;
                }
            }
            
            if ((state.menuFilterMode === 'auto' && hour >= 15) || state.menuFilterMode === 'all') {
                if (chieu.length > 0) {
                    html += `<h3 style="color: var(--primary); padding: 1rem 0 0.5rem; font-size: 18px;">üåô Ca chi·ªÅu</h3>${createListHTML(chieu)}`;
                }
            }
            
            html += '</ul>';

            container.innerHTML = html || `<p class="text-center" style="color: var(--text-muted); padding: 2rem;">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</p>`;
        }

        async function renderOrder() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const targetWeek = (dayOfWeek >= 4 || dayOfWeek === 0) 
                ? getWeekString(new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000))
                : getWeekString(today);

            const userEmailKey = emailToKey(state.currentUser.email);
            const userOrdersForMon = await getDocument(targetWeek, 'mon', false);

            // Check if user already ordered
            if (userOrdersForMon && userOrdersForMon[userEmailKey]) {
                const days = { mon: "Th·ª© 2", tue: "Th·ª© 3", wed: "Th·ª© 4", thu: "Th·ª© 5", fri: "Th·ª© 6" };
                let summaryHTML = `
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">ƒê√£ ƒë·∫∑t m√≥n tu·∫ßn ${targetWeek.split('_')[1]}</h2>
                        </div>
                        <ul class="staff-list">
                `;

                for (const [key, name] of Object.entries(days)) {
                    const dayData = await getDocument(targetWeek, key, false);
                    const dish = dayData?.[userEmailKey]?.food;
                    summaryHTML += `
                        <li class="staff-item">
                            <div class="staff-details">
                                <div class="staff-name">${name}</div>
                                <div class="staff-dish">${parseDish(dish) || 'Ch∆∞a ƒë·∫∑t'}</div>
                            </div>
                        </li>
                    `;
                }

                summaryHTML += `</ul></div>`;
                elements.mainContent.innerHTML = summaryHTML;
                state.cachedData.set('render_order', summaryHTML);
                return;
            }

            // Show order form
            const menu = await getDocument(targetWeek, "menu", false);
            if (!menu) {
                const html = `
                    <div class="card">
                        <div class="text-center">
                            <i class="fas fa-calendar-times" style="font-size: 48px; color: var(--text-muted); margin-bottom: 1rem;"></i>
                            <p style="color: var(--text-muted);">Th·ª±c ƒë∆°n cho tu·∫ßn n√†y ch∆∞a ƒë∆∞·ª£c c·∫≠p nh·∫≠t</p>
                        </div>
                    </div>
                `;
                elements.mainContent.innerHTML = html;
                state.cachedData.set('render_order', html);
                return;
            }

            const days = { mon: "Th·ª© 2", tue: "Th·ª© 3", wed: "Th·ª© 4", thu: "Th·ª© 5", fri: "Th·ª© 6" };
            
            let orderCardsHTML = '';
            for (const [dayKey, dayName] of Object.entries(days)) {
                const dishes = menu[dayKey] || [];
                if (!Array.isArray(dishes) || dishes.length === 0) continue;
                
                orderCardsHTML += `
                    <div class="order-day-card">
                        <div class="order-day-header">
                            <div class="order-day-title">${dayName}</div>
                        </div>
                        <div class="order-dish-list">
                            ${dishes.map((dish, index) => `
                                <div class="order-dish-item ${state.orderSelection[dayKey] === dish ? 'selected' : ''}" 
                                     data-dish="${dish}" data-day-key="${dayKey}">
                                    <div class="order-dish-icon">${getFoodIcon(index)}</div>
                                    <div class="order-dish-name">${parseDish(dish)}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            elements.mainContent.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">ƒê·∫∑t m√≥n tu·∫ßn ${targetWeek.split('_')[1]}</h2>
                    </div>
                    ${orderCardsHTML}
                    <button id="submit-order-btn" class="btn btn-primary btn-block mt-3" disabled>
                        <i class="fas fa-check-circle"></i>
                        Ho√†n t·∫•t ƒë·∫∑t m√≥n
                    </button>
                </div>
            `;
            
            // Check if all days are selected
            checkOrderCompletion();
        }

        function checkOrderCompletion() {
            const days = ['mon', 'tue', 'wed', 'thu', 'fri'];
            const allSelected = days.every(day => state.orderSelection[day]);
            const submitBtn = document.getElementById('submit-order-btn');
            if (submitBtn) {
                submitBtn.disabled = !allSelected;
            }
        }

        async function renderProfile() {
            const user = state.currentUser;
            const profile = state.staffProfile;
            
            elements.mainContent.innerHTML = `
                <div class="card">
                    <div class="profile-section">
                        <img src="${user.photoURL}" alt="avatar" class="profile-avatar">
                        <div class="profile-name">${profile.name}</div>
                        <div class="profile-depart">${profile.depart || 'Ch∆∞a c·∫≠p nh·∫≠t'}</div>
                        
                        <div class="profile-language-toggle">
                            <button class="lang-toggle-btn ${profile.lan === 'vi' ? 'active' : ''}" data-lang="vi">
                                üáªüá≥ Ti·∫øng Vi·ªát
                            </button>
                            <button class="lang-toggle-btn ${profile.lan === 'en' ? 'active' : ''}" data-lang="en">
                                üá¨üáß English
                            </button>
                        </div>
                        
                        <div class="profile-menu">
                            <a href="mailto:${SUPPORT_EMAIL}" class="profile-menu-item" style="text-decoration: none; color: inherit;">
                                <div class="profile-menu-icon green">
                                    <i class="fas fa-headset"></i>
                                </div>
                                <div class="profile-menu-text">
                                    <div class="profile-menu-label">H·ªó tr·ª£</div>
                                    <div class="profile-menu-value">Li√™n h·ªá admin</div>
                                </div>
                                <i class="fas fa-chevron-right" style="color: var(--text-muted);"></i>
                            </a>
                            
                            <div class="profile-menu-item" id="logout-menu-item">
                                <div class="profile-menu-icon red">
                                    <i class="fas fa-sign-out-alt"></i>
                                </div>
                                <div class="profile-menu-text">
                                    <div class="profile-menu-label">ƒêƒÉng xu·∫•t</div>
                                </div>
                                <i class="fas fa-chevron-right" style="color: var(--text-muted);"></i>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function renderAdmin() {
            elements.mainContent.innerHTML = `
                <div class="card">
                    <div class="tabs">
                        <button class="tab-btn ${state.adminSubTab === 'support' ? 'active' : ''}" data-subtab="support">
                            <i class="fas fa-headset"></i> H·ªó tr·ª£
                        </button>
                        <button class="tab-btn ${state.adminSubTab === 'stats' ? 'active' : ''}" data-subtab="stats">
                            <i class="fas fa-chart-bar"></i> Th·ªëng k√™
                        </button>
                        <button class="tab-btn ${state.adminSubTab === 'menu' ? 'active' : ''}" data-subtab="menu">
                            <i class="fas fa-utensils"></i> Th·ª±c ƒë∆°n
                        </button>
                        <button class="tab-btn ${state.adminSubTab === 'personnel' ? 'active' : ''}" data-subtab="personnel">
                            <i class="fas fa-users"></i> Nh√¢n s·ª±
                        </button>
                    </div>
                    <div id="admin-content"></div>
                </div>
            `;
            
            await renderAdminSubTab();
        }

        async function renderAdminSubTab() {
            switch (state.adminSubTab) {
                case 'support':
                    await renderAdminSupport();
                    break;
                case 'stats':
                    await renderAdminStats();
                    break;
                case 'menu':
                    await renderAdminMenu();
                    break;
                case 'personnel':
                    await renderAdminPersonnel();
                    break;
            }
        }

        async function renderAdminSupport() {
            const thisWeek = getWeekString(new Date());
            const [allStaff, monOrders] = await Promise.all([
                getDocument("staff_list", "staffs", true),
                getDocument(thisWeek, "mon")
            ]);

            let notOrderedList = [];
            if (allStaff) {
                for (const key in allStaff) {
                    if (key.startsWith('guest_')) continue;
                    if (!monOrders || !monOrders[key]) {
                        notOrderedList.push({ key, profile: allStaff[key] });
                    }
                }
            }

            notOrderedList.sort((a, b) => a.profile.name.localeCompare(b.profile.name));

            document.getElementById('admin-content').innerHTML = `
                <div class="mt-3">
                    <h3 style="color: var(--primary); margin-bottom: 1rem; font-size: 18px;">
                        <i class="fas fa-exclamation-circle"></i> 
                        Nh√¢n vi√™n ch∆∞a ƒë·∫∑t m√≥n tu·∫ßn n√†y
                    </h3>
                    ${notOrderedList.length > 0 ? `
                        <ul class="staff-list">
                            ${notOrderedList.map(item => `
                                <li class="staff-item">
                                    <div class="staff-details">
                                        <div class="staff-name">${item.profile.name}</div>
                                        <div class="staff-email">${item.profile.email}</div>
                                    </div>
                                    <button class="btn btn-secondary reopen-order-btn" data-key="${item.key}" data-name="${item.profile.name}">
                                        <i class="fas fa-redo"></i>
                                    </button>
                                </li>
                            `).join('')}
                        </ul>
                    ` : `
                        <p class="text-center" style="color: var(--text-muted); padding: 2rem;">
                            <i class="fas fa-check-circle" style="font-size: 48px; margin-bottom: 1rem; display: block;"></i>
                            M·ªçi ng∆∞·ªùi ƒë√£ ƒë·∫∑t m√≥n ƒë·ªß!
                        </p>
                    `}
                    
                    <h3 style="color: var(--primary); margin: 2rem 0 1rem; font-size: 18px;">
                        <i class="fas fa-user-plus"></i> 
                        ƒê·∫∑t m√≥n cho kh√°ch
                    </h3>
                    <button id="add-guest-order-btn" class="btn btn-primary btn-block">
                        <i class="fas fa-plus"></i>
                        Th√™m ƒë·∫∑t m√≥n kh√°ch
                    </button>
                </div>
            `;
        }

        async function renderAdminStats() {
            const content = document.getElementById('admin-content');
            
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            
            content.innerHTML = `
                <div class="mt-3">
                    <div class="tabs">
                        <button class="tab-btn ${state.statsViewMode === 'day' ? 'active' : ''}" data-mode="day">Ng√†y</button>
                        <button class="tab-btn ${state.statsViewMode === 'week' ? 'active' : ''}" data-mode="week">Tu·∫ßn</button>
                        <button class="tab-btn ${state.statsViewMode === 'month' ? 'active' : ''}" data-mode="month">Th√°ng</button>
                    </div>
                    <div class="form-group mt-2">
                        <input type="date" id="stats-date-picker" class="form-input" value="${dateStr}">
                    </div>
                    <div id="stats-content" class="mt-2"></div>
                    <button id="export-stats-btn" class="btn btn-primary btn-block mt-3">
                        <i class="fas fa-file-excel"></i>
                        T·∫£i v·ªÅ XLSX
                    </button>
                </div>
            `;

            await renderStatsContent();
        }

        async function renderStatsContent() {
            const statsContent = document.getElementById('stats-content');
            
            if (state.statsViewMode === 'day') {
                const dayKey = getDayKey(state.statsViewDate);
                const weekString = getWeekString(state.statsViewDate);
                const dayData = await getDocument(weekString, dayKey);

                if (!dayData) {
                    statsContent.innerHTML = `<p class="text-center" style="color: var(--text-muted);">Kh√¥ng c√≥ d·ªØ li·ªáu</p>`;
                    return;
                }

                const statsM = {};
                const statsE = {};
                
                Object.values(dayData).forEach(order => {
                    const dish = parseDish(order.food);
                    const shift = order.shift || 'M';
                    const target = shift === 'M' ? statsM : statsE;
                    
                    if (!target[dish]) {
                        target[dish] = { ordered: 0, eaten: 0, notEaten: 0 };
                    }
                    target[dish].ordered++;
                    if (order.status === 'eaten') {
                        target[dish].eaten++;
                    } else {
                        target[dish].notEaten++;
                    }
                });

                const createTable = (stats, shiftName) => {
                    const totalOrdered = Object.values(stats).reduce((sum, s) => sum + s.ordered, 0);
                    const totalEaten = Object.values(stats).reduce((sum, s) => sum + s.eaten, 0);
                    const totalNotEaten = Object.values(stats).reduce((sum, s) => sum + s.notEaten, 0);
                    
                    return `
                        <h4 style="color: var(--primary); margin: 1rem 0 0.5rem;">${shiftName}</h4>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>M√≥n ƒÉn</th>
                                        <th>ƒê√£ ƒë·∫∑t</th>
                                        <th>ƒê√£ ƒÉn</th>
                                        <th>Ch∆∞a ƒÉn</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${Object.entries(stats).map(([dish, data]) => `
                                        <tr>
                                            <td>${dish}</td>
                                            <td>${data.ordered}</td>
                                            <td>${data.eaten}</td>
                                            <td>${data.notEaten}</td>
                                        </tr>
                                    `).join('')}
                                    <tr style="font-weight: 600; background: rgba(102, 126, 234, 0.1);">
                                        <td>T·ªïng</td>
                                        <td>${totalOrdered}</td>
                                        <td>${totalEaten}</td>
                                        <td>${totalNotEaten}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    `;
                };

                statsContent.innerHTML = (Object.keys(statsM).length > 0 ? createTable(statsM, '‚òÄÔ∏è Ca s√°ng') : '') +
                                        (Object.keys(statsE).length > 0 ? createTable(statsE, 'üåô Ca chi·ªÅu') : '');
            } else if (state.statsViewMode === 'week') {
                const weekString = getWeekString(state.statsViewDate);
                const days = ['mon', 'tue', 'wed', 'thu', 'fri'];
                const departStats = {};
                
                for (const day of days) {
                    const dayData = await getDocument(weekString, day);
                    if (!dayData) continue;
                    
                    Object.values(dayData).forEach(order => {
                        const depart = order.depart || 'Ch∆∞a r√µ';
                        if (!departStats[depart]) {
                            departStats[depart] = { ordered: 0, eaten: 0, notEaten: 0 };
                        }
                        departStats[depart].ordered++;
                        if (order.status === 'eaten') {
                            departStats[depart].eaten++;
                        } else {
                            departStats[depart].notEaten++;
                        }
                    });
                }
                
                const totalOrdered = Object.values(departStats).reduce((sum, s) => sum + s.ordered, 0);
                const totalEaten = Object.values(departStats).reduce((sum, s) => sum + s.eaten, 0);
                const totalNotEaten = Object.values(departStats).reduce((sum, s) => sum + s.notEaten, 0);
                
                statsContent.innerHTML = `
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Ph√≤ng ban</th>
                                    <th>ƒê√£ ƒë·∫∑t</th>
                                    <th>ƒê√£ ƒÉn</th>
                                    <th>Ch∆∞a ƒÉn</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(departStats).map(([depart, data]) => `
                                    <tr>
                                        <td>${depart}</td>
                                        <td>${data.ordered}</td>
                                        <td>${data.eaten}</td>
                                        <td>${data.notEaten}</td>
                                    </tr>
                                `).join('')}
                                <tr style="font-weight: 600; background: rgba(102, 126, 234, 0.1);">
                                    <td>T·ªïng</td>
                                    <td>${totalOrdered}</td>
                                    <td>${totalEaten}</td>
                                    <td>${totalNotEaten}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
            } else if (state.statsViewMode === 'month') {
                // Get all weeks in current month
                const currentDate = state.statsViewDate;
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                
                const departStats = {};
                
                // Loop through all days in month
                for (let d = new Date(firstDay); d <= lastDay; d.setDate(d.getDate() + 1)) {
                    const dayOfWeek = d.getDay();
                    if (dayOfWeek === 0 || dayOfWeek === 6) continue; // Skip weekends
                    
                    const weekString = getWeekString(d);
                    const dayKey = getDayKey(d);
                    const dayData = await getDocument(weekString, dayKey);
                    
                    if (!dayData) continue;
                    
                    Object.values(dayData).forEach(order => {
                        const depart = order.depart || 'Ch∆∞a r√µ';
                        if (!departStats[depart]) {
                            departStats[depart] = { ordered: 0, eaten: 0, notEaten: 0 };
                        }
                        departStats[depart].ordered++;
                        if (order.status === 'eaten') {
                            departStats[depart].eaten++;
                        } else {
                            departStats[depart].notEaten++;
                        }
                    });
                }
                
                const totalOrdered = Object.values(departStats).reduce((sum, s) => sum + s.ordered, 0);
                const totalEaten = Object.values(departStats).reduce((sum, s) => sum + s.eaten, 0);
                const totalNotEaten = Object.values(departStats).reduce((sum, s) => sum + s.notEaten, 0);
                
                statsContent.innerHTML = `
                    <h4 style="color: var(--primary); margin: 0 0 1rem;">Th√°ng ${month + 1}/${year}</h4>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Ph√≤ng ban</th>
                                    <th>ƒê√£ ƒë·∫∑t</th>
                                    <th>ƒê√£ ƒÉn</th>
                                    <th>Ch∆∞a ƒÉn</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(departStats).map(([depart, data]) => `
                                    <tr>
                                        <td>${depart}</td>
                                        <td>${data.ordered}</td>
                                        <td>${data.eaten}</td>
                                        <td>${data.notEaten}</td>
                                    </tr>
                                `).join('')}
                                <tr style="font-weight: 600; background: rgba(102, 126, 234, 0.1);">
                                    <td>T·ªïng</td>
                                    <td>${totalOrdered}</td>
                                    <td>${totalEaten}</td>
                                    <td>${totalNotEaten}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
            }
        }

        async function renderAdminMenu() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const thisWeek = getWeekString(today);
            const nextWeek = getWeekString(new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000));
            const [thisMenuData, nextMenuData] = await Promise.all([
                getDocument(thisWeek, "menu"),
                getDocument(nextWeek, "menu")
            ]);
            const isEditable = dayOfWeek >= 1 && dayOfWeek <= 4;
            const days = { mon: "Th·ª© 2", tue: "Th·ª© 3", wed: "Th·ª© 4", thu: "Th·ª© 5", fri: "Th·ª© 6" };

            const renderMenuSection = (menuData, weekStr, editable, title) => {
                let html = `<h3 style="color: var(--primary); margin: 1.5rem 0 1rem; font-size: 18px;">${title}</h3>`;
                
                for (const [key, name] of Object.entries(days)) {
                    const dishes = menuData?.[key] || [];
                    // Ensure dishes is always an array
                    const dishesArray = Array.isArray(dishes) ? dishes : [];
                    
                    html += `
                        <div class="form-group">
                            <label class="form-label">${name}</label>
                            ${editable ? `
                                <div id="menu-dishes-${weekStr}-${key}">
                                    ${dishesArray.map((dish, idx) => `
                                        <div class="menu-item">
                                            <div class="menu-item-icon">${getFoodIcon(idx)}</div>
                                            <div class="menu-item-text">${dish}</div>
                                            <button class="icon-btn remove-dish-btn" data-week="${weekStr}" data-day="${key}" data-index="${idx}">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    `).join('')}
                                    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                                        <input type="text" id="new-dish-${weekStr}-${key}" class="form-input" placeholder="M√≥n Vi·ªát|English dish" style="flex: 1;">
                                        <button class="icon-btn add-dish-btn" data-week="${weekStr}" data-day="${key}">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            ` : `
                                <div>
                                    ${dishesArray.length > 0 ? dishesArray.map((dish, idx) => `
                                        <div class="menu-item">
                                            <div class="menu-item-icon">${getFoodIcon(idx)}</div>
                                            <div class="menu-item-text">${dish}</div>
                                        </div>
                                    `).join('') : '<p style="color: var(--text-muted); font-size: 13px; padding: 0.5rem 0;">Ch∆∞a c√≥ m√≥n</p>'}
                                </div>
                            `}
                        </div>
                    `;
                }
                
                if (editable) {
                    html += `
                        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                            <button id="import-menu-btn-${weekStr}" class="btn btn-secondary" style="flex: 1;">
                                <i class="fas fa-file-import"></i>
                                Import XLSX
                            </button>
                            <button id="export-menu-btn-${weekStr}" class="btn btn-secondary" style="flex: 1;">
                                <i class="fas fa-file-export"></i>
                                Export XLSX
                            </button>
                        </div>
                        <button id="save-menu-btn-${weekStr}" class="btn btn-primary btn-block mt-2">
                            <i class="fas fa-save"></i>
                            L∆∞u Th·ª±c ƒë∆°n
                        </button>
                    `;
                } else {
                    html += `
                        <button id="export-menu-btn-${weekStr}" class="btn btn-secondary btn-block mt-2">
                            <i class="fas fa-file-export"></i>
                            Export XLSX
                        </button>
                    `;
                }
                
                return html;
            };

            document.getElementById('admin-content').innerHTML = `
                <div class="mt-3">
                    ${renderMenuSection(thisMenuData, thisWeek, false, `Th·ª±c ƒë∆°n tu·∫ßn n√†y (${thisWeek.split('_')[1]})`)}
                    ${renderMenuSection(nextMenuData, nextWeek, isEditable, `Th·ª±c ƒë∆°n tu·∫ßn sau (${nextWeek.split('_')[1]})`)}
                </div>
            `;
        }

        async function renderAdminPersonnel() {
            const allStaff = await getDocument("staff_list", "staffs", true);
            let tableRows = '';

            if (allStaff) {
                const sorted = Object.entries(allStaff)
                    .filter(([key]) => !key.startsWith('guest_'))
                    .sort((a, b) => a[1].name.localeCompare(b[1].name));
                    
                tableRows = sorted.map(([key, profile]) => `
                    <tr>
                        <td>${profile.name}</td>
                        <td class="hide-mobile">${profile.email}</td>
                        <td class="hide-mobile">${profile.depart || '-'}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="icon-btn edit-personnel-btn" data-key="${key}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="icon-btn delete-personnel-btn" data-key="${key}" data-name="${profile.name}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }

            document.getElementById('admin-content').innerHTML = `
                <div class="mt-3">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="color: var(--primary); font-size: 18px;">Qu·∫£n l√Ω nh√¢n s·ª±</h3>
                        <div style="display: flex; gap: 8px;">
                            <button id="add-personnel-btn" class="icon-btn">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button id="export-personnel-btn" class="icon-btn">
                                <i class="fas fa-file-excel"></i>
                            </button>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>T√™n</th>
                                    <th class="hide-mobile">Email</th>
                                    <th class="hide-mobile">Ph√≤ng ban</th>
                                    <th style="width: 120px;">Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows || '<tr><td colspan="4" class="text-center" style="color: var(--text-muted);">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        async function syncUserProfile() {
            const user = state.currentUser;
            const userEmailKey = emailToKey(user.email);
            const staffData = await getDocument("staff_list", "staffs", true);

            if (!staffData || !staffData[userEmailKey]) {
                await signOut(auth);
                throw new Error("T√†i kho·∫£n c·ªßa b·∫°n kh√¥ng c√≥ trong danh s√°ch ƒë∆∞·ª£c ph√©p.");
            }

            state.staffProfile = staffData[userEmailKey];
            state.isAdmin = ADMIN_EMAILS.includes(user.email);
        }

        function updateUIForUser(user) {
            if (user && state.staffProfile) {
                let tabBarHTML = `
                    <button class="nav-item active" data-tab="today">
                        <i class="fas fa-home"></i>
                        <span>H√¥m Nay</span>
                    </button>
                    <button class="nav-item" data-tab="menu">
                        <i class="fas fa-list"></i>
                        <span>Th·ª±c ƒë∆°n</span>
                    </button>
                    <button class="nav-item" data-tab="order">
                        <i class="fas fa-shopping-cart"></i>
                        <span>ƒê·∫∑t M√≥n</span>
                    </button>
                `;

                if (state.isAdmin) {
                    tabBarHTML += `
                        <button class="nav-item" data-tab="admin">
                            <i class="fas fa-crown"></i>
                            <span>Admin</span>
                        </button>
                    `;
                }

                tabBarHTML += `
                    <button class="nav-item" data-tab="profile">
                        <img src="${user.photoURL}" alt="avatar">
                        <span>C√° nh√¢n</span>
                    </button>
                `;

                elements.tabBar.innerHTML = tabBarHTML;
                elements.tabBar.classList.remove('hidden');
            } else {
                elements.tabBar.classList.add('hidden');
                elements.mainContent.innerHTML = `
                    <div class="card hero-card">
                        <div class="hero-content">
                            <div class="hero-title">Ch√†o m·ª´ng! üëã</div>
                            <div class="hero-subtitle" style="margin-bottom: 2rem;">Vui l√≤ng ƒëƒÉng nh·∫≠p b·∫±ng t√†i kho·∫£n c√¥ng ty</div>
                            <button id="login-btn" class="btn btn-primary">
                                <i class="fab fa-google"></i>
                                ƒêƒÉng nh·∫≠p b·∫±ng Google
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        // Event Listeners
        document.body.addEventListener('change', async (e) => {
            // Stats date picker change
            if (e.target.id === 'stats-date-picker') {
                state.statsViewDate = new Date(e.target.value);
                await renderStatsContent();
                return;
            }
        });
        
        document.body.addEventListener('click', async (e) => {
            const target = e.target.closest('button, a, .profile-menu-item, .order-dish-item');
            if (!target) return;

            // Login
            if (target.id === 'login-btn' || target.closest('#login-btn')) {
                showLoader();
                try {
                    await signInWithPopup(auth, provider);
                } catch (err) {
                    console.error('Login error:', err);
                    showToast('ƒêƒÉng nh·∫≠p th·∫•t b·∫°i. T√†i kho·∫£n c·ªßa b·∫°n c√≥ th·ªÉ kh√¥ng ƒë∆∞·ª£c ph√©p.', 'error');
                    hideLoader();
                }
                return;
            }

            // Language toggle in profile
            if (target.classList.contains('lang-toggle-btn')) {
                const newLang = target.dataset.lang;
                if (newLang === state.staffProfile.lan) return;
                
                showLoader();
                try {
                    await updateDoc(doc(db, "staff_list", "staffs"), {
                        [`${emailToKey(state.currentUser.email)}.lan`]: newLang
                    });
                    state.staffProfile.lan = newLang;
                    state.cachedData.delete("staff_list/staffs");
                    state.cachedData.delete('render_today');
                    state.cachedData.delete('render_order');
                    showToast(`ƒê√£ chuy·ªÉn sang ${newLang === 'vi' ? 'Ti·∫øng Vi·ªát' : 'English'}`);
                    await renderProfile();
                } catch (error) {
                    showToast('C·∫≠p nh·∫≠t ng√¥n ng·ªØ th·∫•t b·∫°i', 'error');
                }
                hideLoader();
                return;
            }

            // Logout
            if (target.id === 'logout-menu-item' || target.closest('#logout-menu-item')) {
                if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) {
                    await signOut(auth);
                    showToast('ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng');
                }
                return;
            }

            // Language menu
            if (target.id === 'language-menu-item' || target.closest('#language-menu-item')) {
                const currentLang = state.staffProfile.lan || 'vi';
                document.querySelector(`input[name="language"][value="${currentLang}"]`).checked = true;
                elements.languageModal.classList.remove('hidden');
                return;
            }

            // Tab Navigation
            if (target.classList.contains('nav-item')) {
                const tab = target.dataset.tab;
                if (tab === state.currentTab) return;
                
                document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                target.classList.add('active');
                state.currentTab = tab;
                
                // Clear cache for menu tab
                if (tab === 'menu') {
                    const weekString = getWeekString(new Date());
                    const dayKey = getDayKey();
                    state.cachedData.delete(`${weekString}/${dayKey}`);
                }
                
                await render();
                return;
            }

            // Admin Sub Tabs
            if (target.dataset.subtab) {
                state.adminSubTab = target.dataset.subtab;
                document.querySelectorAll('[data-subtab]').forEach(btn => btn.classList.remove('active'));
                target.classList.add('active');
                await renderAdminSubTab();
                return;
            }

            // Stats mode tabs
            if (target.dataset.mode) {
                state.statsViewMode = target.dataset.mode;
                document.querySelectorAll('[data-mode]').forEach(btn => btn.classList.remove('active'));
                target.classList.add('active');
                await renderStatsContent();
                return;
            }
            
            // Stats date picker change
            if (target.id === 'stats-date-picker') {
                target.addEventListener('change', async (e) => {
                    state.statsViewDate = new Date(e.target.value);
                    await renderStatsContent();
                });
                return;
            }

            // Menu Filter
            if (target.id === 'menu-filter-btn' || target.closest('#menu-filter-btn')) {
                state.menuFilterMode = state.menuFilterMode === 'auto' ? 'all' : 'auto';
                const dayKey = getDayKey();
                const weekString = getWeekString(new Date());
                const dayData = await getDocument(weekString, dayKey, true);
                if (dayData) updateStaffListView(dayData);
                return;
            }

            // Language Modal
            if (target.id === 'close-language-btn' || (target === elements.languageModal && e.target === elements.languageModal)) {
                elements.languageModal.classList.add('hidden');
                return;
            }

            if (target.id === 'save-language-btn') {
                showLoader();
                try {
                    const newLang = document.querySelector('input[name="language"]:checked').value;
                    await updateDoc(doc(db, "staff_list", "staffs"), {
                        [`${emailToKey(state.currentUser.email)}.lan`]: newLang
                    });
                    state.staffProfile.lan = newLang;
                    state.cachedData.delete("staff_list/staffs");
                    state.cachedData.delete('render_today');
                    state.cachedData.delete('render_order');
                    elements.languageModal.classList.add('hidden');
                    showToast(`ƒê√£ chuy·ªÉn sang ${newLang === 'vi' ? 'Ti·∫øng Vi·ªát' : 'English'}`);
                    await render();
                } catch (error) {
                    showToast('C·∫≠p nh·∫≠t ng√¥n ng·ªØ th·∫•t b·∫°i', 'error');
                }
                hideLoader();
                return;
            }

            // Order Dish Selection
            if (target.classList.contains('order-dish-item')) {
                const dayKey = target.dataset.dayKey;
                const dish = target.dataset.dish;
                
                state.orderSelection[dayKey] = dish;
                
                // Update UI
                document.querySelectorAll(`[data-day-key="${dayKey}"]`).forEach(item => {
                    item.classList.remove('selected');
                });
                target.classList.add('selected');
                
                checkOrderCompletion();
                return;
            }

            // Submit Order
            if (target.id === 'submit-order-btn') {
                showLoader();
                try {
                    const today = new Date();
                    const dayOfWeek = today.getDay();
                    const targetWeek = (dayOfWeek >= 4 || dayOfWeek === 0)
                        ? getWeekString(new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000))
                        : getWeekString(today);

                    const userEmailKey = emailToKey(state.currentUser.email);
                    
                    for (const dayKey in state.orderSelection) {
                        const dayDocRef = doc(db, targetWeek, dayKey);
                        
                        // Get shift from personnel modal or default
                        const departsData = await getDocument('staff_list', 'departs');
                        const shiftInput = document.querySelector('input[name="order-shift"]:checked');
                        const shift = shiftInput ? shiftInput.value : 'M';
                        
                        const updatePayload = {
                            [userEmailKey]: {
                                name: state.staffProfile.name,
                                email: state.currentUser.email,
                                food: state.orderSelection[dayKey],
                                status: 'not',
                                shift: shift,
                                depart: state.staffProfile.depart,
                            }
                        };
                        await setDoc(dayDocRef, updatePayload, { merge: true });
                        state.cachedData.delete(`${targetWeek}/${dayKey}`);
                    }

                    showToast('ƒê·∫∑t m√≥n th√†nh c√¥ng!');
                    state.orderSelection = {};
                    state.cachedData.delete('render_order');
                    state.cachedData.delete('render_today');
                    
                    // Switch to today tab
                    state.currentTab = 'today';
                    document.querySelectorAll('.nav-item').forEach(item => {
                        item.classList.toggle('active', item.dataset.tab === 'today');
                    });
                    await render();
                } catch (error) {
                    console.error('Order submission error:', error);
                    showToast('ƒê·∫∑t m√≥n th·∫•t b·∫°i', 'error');
                }
                hideLoader();
                return;
            }

            // Admin: Add Guest Order
            if (target.id === 'add-guest-order-btn' || target.closest('#add-guest-order-btn')) {
                document.getElementById('guest-name-input').value = '';
                document.getElementById('guest-depart-input').value = '';
                document.querySelector('input[name="guest-shift"][value="M"]').checked = true;
                document.querySelector('input[name="guest-week"][value="this"]').checked = true;
                state.guestOrderSelection = {};
                await renderGuestOrderDays('this');
                elements.guestOrderModal.classList.remove('hidden');
                return;
            }

            // Guest order week change
            if (target.name === 'guest-week') {
                await renderGuestOrderDays(target.value);
                return;
            }

            // Admin: Reopen Order
            if (target.classList.contains('reopen-order-btn') || target.closest('.reopen-order-btn')) {
                const btn = target.classList.contains('reopen-order-btn') ? target : target.closest('.reopen-order-btn');
                state.reopenTarget = { key: btn.dataset.key, name: btn.dataset.name };
                document.getElementById('reopen-order-modal-title').textContent = `M·ªü l·∫°i ƒë·∫∑t m√≥n cho ${state.reopenTarget.name}?`;
                elements.reopenOrderModal.classList.remove('hidden');
                return;
            }

            if (target.id === 'close-reopen-order-modal-btn' || (target === elements.reopenOrderModal && e.target === elements.reopenOrderModal)) {
                elements.reopenOrderModal.classList.add('hidden');
                return;
            }

            if (target.id === 'confirm-reopen-order-btn') {
                showLoader();
                try {
                    const weekString = getWeekString(new Date());
                    const days = ['mon', 'tue', 'wed', 'thu', 'fri'];
                    
                    for (const day of days) {
                        const docRef = doc(db, weekString, day);
                        await updateDoc(docRef, { [state.reopenTarget.key]: deleteField() });
                        state.cachedData.delete(`${weekString}/${day}`);
                    }
                    
                    showToast(`ƒê√£ m·ªü l·∫°i ƒë·∫∑t m√≥n cho ${state.reopenTarget.name}`);
                    elements.reopenOrderModal.classList.add('hidden');
                    await renderAdmin();
                } catch (error) {
                    showToast('C√≥ l·ªói x·∫£y ra', 'error');
                    console.error(error);
                }
                hideLoader();
                return;
            }

            // Admin: Menu Management
            if (target.classList.contains('add-dish-btn')) {
                const weekStr = target.dataset.week;
                const dayKey = target.dataset.day;
                const input = document.getElementById(`new-dish-${weekStr}-${dayKey}`);
                const dishValue = input.value.trim();
                
                if (!dishValue) return;
                
                const menuData = await getDocument(weekStr, "menu") || {};
                
                if (!menuData[dayKey]) menuData[dayKey] = [];
                if (!Array.isArray(menuData[dayKey])) menuData[dayKey] = [];
                
                menuData[dayKey].push(dishValue);
                
                await setDoc(doc(db, weekStr, "menu"), menuData);
                state.cachedData.delete(`${weekStr}/menu`);
                
                input.value = '';
                await renderAdminMenu();
                return;
            }

            if (target.classList.contains('remove-dish-btn')) {
                const weekStr = target.dataset.week;
                const dayKey = target.dataset.day;
                const index = parseInt(target.dataset.index);
                
                const menuData = await getDocument(weekStr, "menu") || {};
                
                if (menuData[dayKey] && Array.isArray(menuData[dayKey])) {
                    menuData[dayKey].splice(index, 1);
                    await setDoc(doc(db, weekStr, "menu"), menuData);
                    state.cachedData.delete(`${weekStr}/menu`);
                    await renderAdminMenu();
                }
                return;
            }

            if (target.id && target.id.startsWith('save-menu-btn-')) {
                showLoader();
                try {
                    const weekStr = target.id.replace('save-menu-btn-', '');
                    showToast('L∆∞u th·ª±c ƒë∆°n th√†nh c√¥ng!');
                } catch (error) {
                    showToast('L∆∞u th·ª±c ƒë∆°n th·∫•t b·∫°i', 'error');
                    console.error(error);
                }
                hideLoader();
                return;
            }

            if (target.id && target.id.startsWith('export-menu-btn-')) {
                const weekStr = target.id.replace('export-menu-btn-', '');
                const menuData = await getDocument(weekStr, "menu");
                
                if (!menuData) {
                    showToast('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t', 'error');
                    return;
                }
                
                const days = { mon: "Th·ª© 2", tue: "Th·ª© 3", wed: "Th·ª© 4", thu: "Th·ª© 5", fri: "Th·ª© 6" };
                const exportData = [];
                
                for (const [key, name] of Object.entries(days)) {
                    const dishes = menuData[key] || [];
                    const dishesArray = Array.isArray(dishes) ? dishes : [];
                    dishesArray.forEach((dish, idx) => {
                        exportData.push({
                            'Ng√†y': name,
                            'STT': idx + 1,
                            'M√≥n ƒÉn': dish
                        });
                    });
                }
                
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Th·ª±c ƒë∆°n");
                XLSX.writeFile(wb, `thuc-don-${weekStr}.xlsx`);
                showToast('ƒê√£ t·∫£i v·ªÅ file Excel');
                return;
            }

            if (target.id && target.id.startsWith('import-menu-btn-')) {
                const weekStr = target.id.replace('import-menu-btn-', '');
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.xlsx,.xls';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    showLoader();
                    try {
                        const data = await file.arrayBuffer();
                        const workbook = XLSX.read(data);
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(sheet);
                        
                        const menuData = { mon: [], tue: [], wed: [], thu: [], fri: [] };
                        const dayMap = { 'Th·ª© 2': 'mon', 'Th·ª© 3': 'tue', 'Th·ª© 4': 'wed', 'Th·ª© 5': 'thu', 'Th·ª© 6': 'fri' };
                        
                        jsonData.forEach(row => {
                            const dayKey = dayMap[row['Ng√†y']];
                            const dish = row['M√≥n ƒÉn'];
                            if (dayKey && dish) {
                                menuData[dayKey].push(dish);
                            }
                        });
                        
                        await setDoc(doc(db, weekStr, "menu"), menuData);
                        state.cachedData.delete(`${weekStr}/menu`);
                        showToast('Import th√†nh c√¥ng!');
                        await renderAdminMenu();
                    } catch (error) {
                        showToast('Import th·∫•t b·∫°i', 'error');
                        console.error(error);
                    }
                    hideLoader();
                };
                input.click();
                return;
            }

            // Admin: Add Personnel
            if (target.id === 'add-personnel-btn' || target.closest('#add-personnel-btn')) {
                document.getElementById('personnel-modal-title').textContent = 'Th√™m nh√¢n vi√™n';
                document.getElementById('personnel-original-email-key').value = '';
                document.getElementById('personnel-name-input').value = '';
                document.getElementById('personnel-email-input').value = '';
                
                const departsData = await getDocument('staff_list', 'departs');
                const departSelect = document.getElementById('personnel-depart-select');
                if (departsData) {
                    departSelect.innerHTML = (departsData.list || [])
                        .map(d => `<option value="${d}">${d}</option>`)
                        .join('');
                }
                
                elements.personnelModal.classList.remove('hidden');
                return;
            }

            // Admin: Edit Personnel
            if (target.classList.contains('edit-personnel-btn') || target.closest('.edit-personnel-btn')) {
                const btn = target.classList.contains('edit-personnel-btn') ? target : target.closest('.edit-personnel-btn');
                const key = btn.dataset.key;
                const allStaff = await getDocument("staff_list", "staffs", true);
                const profile = allStaff[key];
                
                document.getElementById('personnel-modal-title').textContent = 'S·ª≠a th√¥ng tin';
                document.getElementById('personnel-original-email-key').value = key;
                document.getElementById('personnel-name-input').value = profile.name;
                document.getElementById('personnel-email-input').value = profile.email;
                
                const departsData = await getDocument('staff_list', 'departs');
                const departSelect = document.getElementById('personnel-depart-select');
                if (departsData) {
                    departSelect.innerHTML = (departsData.list || [])
                        .map(d => `<option value="${d}" ${d === profile.depart ? 'selected' : ''}>${d}</option>`)
                        .join('');
                }
                
                elements.personnelModal.classList.remove('hidden');
                return;
            }

            // Admin: Delete Personnel
            if (target.classList.contains('delete-personnel-btn') || target.closest('.delete-personnel-btn')) {
                const btn = target.classList.contains('delete-personnel-btn') ? target : target.closest('.delete-personnel-btn');
                state.deleteTarget = { key: btn.dataset.key, name: btn.dataset.name };
                document.getElementById('delete-personnel-text').textContent = `B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a nh√¢n vi√™n "${state.deleteTarget.name}"? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.`;
                elements.deletePersonnelModal.classList.remove('hidden');
                return;
            }

            // Personnel Modal
            if (target.id === 'close-personnel-modal-btn' || (target === elements.personnelModal && e.target === elements.personnelModal)) {
                elements.personnelModal.classList.add('hidden');
                return;
            }

            if (target.id === 'save-personnel-btn') {
                showLoader();
                try {
                    const name = document.getElementById('personnel-name-input').value.trim();
                    const email = document.getElementById('personnel-email-input').value.trim();
                    const depart = document.getElementById('personnel-depart-select').value;
                    const originalKey = document.getElementById('personnel-original-email-key').value;
                    
                    if (!name || !email) {
                        showToast('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin', 'error');
                        hideLoader();
                        return;
                    }
                    
                    const newKey = emailToKey(email);
                    const staffRef = doc(db, "staff_list", "staffs");
                    const allStaff = await getDocument("staff_list", "staffs", true);
                    
                    // If editing and email changed, delete old entry
                    if (originalKey && originalKey !== newKey) {
                        delete allStaff[originalKey];
                    }
                    
                    allStaff[newKey] = {
                        name,
                        email,
                        depart,
                        lan: allStaff[newKey]?.lan || 'vi'
                    };
                    
                    await setDoc(staffRef, allStaff);
                    state.cachedData.delete("staff_list/staffs");
                    
                    elements.personnelModal.classList.add('hidden');
                    showToast(originalKey ? 'C·∫≠p nh·∫≠t th√†nh c√¥ng!' : 'Th√™m nh√¢n vi√™n th√†nh c√¥ng!');
                    await renderAdminPersonnel();
                } catch (error) {
                    showToast('C√≥ l·ªói x·∫£y ra', 'error');
                    console.error(error);
                }
                hideLoader();
                return;
            }

            // Delete Personnel Modal
            if (target.id === 'close-delete-personnel-modal-btn' || target.id === 'cancel-delete-personnel-btn' || (target === elements.deletePersonnelModal && e.target === elements.deletePersonnelModal)) {
                elements.deletePersonnelModal.classList.add('hidden');
                return;
            }

            if (target.id === 'confirm-delete-personnel-btn') {
                showLoader();
                try {
                    const staffRef = doc(db, "staff_list", "staffs");
                    await updateDoc(staffRef, { [state.deleteTarget.key]: deleteField() });
                    state.cachedData.delete("staff_list/staffs");
                    
                    elements.deletePersonnelModal.classList.add('hidden');
                    showToast('ƒê√£ x√≥a nh√¢n vi√™n');
                    await renderAdminPersonnel();
                } catch (error) {
                    showToast('C√≥ l·ªói x·∫£y ra', 'error');
                    console.error(error);
                }
                hideLoader();
                return;
            }

            // Export Personnel
            if (target.id === 'export-personnel-btn' || target.closest('#export-personnel-btn')) {
                const allStaff = await getDocument("staff_list", "staffs", true);
                if (!allStaff) return;
                
                const data = Object.entries(allStaff)
                    .filter(([key]) => !key.startsWith('guest_'))
                    .map(([key, profile]) => ({
                        'T√™n': profile.name,
                        'Email': profile.email,
                        'Ph√≤ng ban': profile.depart,
                        'Ng√¥n ng·ªØ': profile.lan
                    }));
                
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Nh√¢n s·ª±");
                XLSX.writeFile(wb, `nhan-su-${new Date().toISOString().split('T')[0]}.xlsx`);
                showToast('ƒê√£ t·∫£i v·ªÅ file Excel');
                return;
            }

            // Export Stats
            if (target.id === 'export-stats-btn') {
                showLoader();
                try {
                    if (state.statsViewMode === 'day') {
                        const dayKey = getDayKey(state.statsViewDate);
                        const weekString = getWeekString(state.statsViewDate);
                        const dayData = await getDocument(weekString, dayKey);
                        
                        if (!dayData) {
                            showToast('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t', 'error');
                            hideLoader();
                            return;
                        }
                        
                        const data = Object.entries(dayData).map(([key, order]) => ({
                            'T√™n': order.name,
                            'Email': order.email,
                            'M√≥n ƒÉn': parseDish(order.food),
                            'Ca': order.shift === 'M' ? 'S√°ng' : 'Chi·ªÅu',
                            'Ph√≤ng ban': order.depart,
                            'Tr·∫°ng th√°i': order.status === 'eaten' ? 'ƒê√£ ƒÉn' : 'Ch∆∞a ƒÉn'
                        }));
                        
                        const ws = XLSX.utils.json_to_sheet(data);
                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, "Th·ªëng k√™");
                        XLSX.writeFile(wb, `thong-ke-ngay-${weekString}-${dayKey}.xlsx`);
                        showToast('ƒê√£ t·∫£i v·ªÅ file Excel');
                    } else if (state.statsViewMode === 'week') {
                        const weekString = getWeekString(state.statsViewDate);
                        const days = ['mon', 'tue', 'wed', 'thu', 'fri'];
                        const allOrders = [];
                        
                        for (const day of days) {
                            const dayData = await getDocument(weekString, day);
                            if (!dayData) continue;
                            
                            Object.entries(dayData).forEach(([key, order]) => {
                                allOrders.push({
                                    'T√™n': order.name,
                                    'Email': order.email,
                                    'M√≥n ƒÉn': parseDish(order.food),
                                    'Ca': order.shift === 'M' ? 'S√°ng' : 'Chi·ªÅu',
                                    'Ph√≤ng ban': order.depart,
                                    'Ng√†y': {'mon': 'Th·ª© 2', 'tue': 'Th·ª© 3', 'wed': 'Th·ª© 4', 'thu': 'Th·ª© 5', 'fri': 'Th·ª© 6'}[day],
                                    'Tr·∫°ng th√°i': order.status === 'eaten' ? 'ƒê√£ ƒÉn' : 'Ch∆∞a ƒÉn'
                                });
                            });
                        }
                        
                        if (allOrders.length === 0) {
                            showToast('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t', 'error');
                            hideLoader();
                            return;
                        }
                        
                        const ws = XLSX.utils.json_to_sheet(allOrders);
                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, "Th·ªëng k√™");
                        XLSX.writeFile(wb, `thong-ke-tuan-${weekString}.xlsx`);
                        showToast('ƒê√£ t·∫£i v·ªÅ file Excel');
                    } else if (state.statsViewMode === 'month') {
                        const currentDate = state.statsViewDate;
                        const year = currentDate.getFullYear();
                        const month = currentDate.getMonth();
                        const firstDay = new Date(year, month, 1);
                        const lastDay = new Date(year, month + 1, 0);
                        
                        const allOrders = [];
                        
                        for (let d = new Date(firstDay); d <= lastDay; d.setDate(d.getDate() + 1)) {
                            const dayOfWeek = d.getDay();
                            if (dayOfWeek === 0 || dayOfWeek === 6) continue;
                            
                            const weekString = getWeekString(d);
                            const dayKey = getDayKey(d);
                            const dayData = await getDocument(weekString, dayKey);
                            
                            if (!dayData) continue;
                            
                            Object.entries(dayData).forEach(([key, order]) => {
                                allOrders.push({
                                    'T√™n': order.name,
                                    'Email': order.email,
                                    'M√≥n ƒÉn': parseDish(order.food),
                                    'Ca': order.shift === 'M' ? 'S√°ng' : 'Chi·ªÅu',
                                    'Ph√≤ng ban': order.depart,
                                    'Ng√†y': `${d.getDate()}/${month + 1}/${year}`,
                                    'Tr·∫°ng th√°i': order.status === 'eaten' ? 'ƒê√£ ƒÉn' : 'Ch∆∞a ƒÉn'
                                });
                            });
                        }
                        
                        if (allOrders.length === 0) {
                            showToast('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t', 'error');
                            hideLoader();
                            return;
                        }
                        
                        const ws = XLSX.utils.json_to_sheet(allOrders);
                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, "Th·ªëng k√™");
                        XLSX.writeFile(wb, `thong-ke-thang-${month + 1}-${year}.xlsx`);
                        showToast('ƒê√£ t·∫£i v·ªÅ file Excel');
                    }
                } catch (error) {
                    showToast('Xu·∫•t file th·∫•t b·∫°i', 'error');
                    console.error(error);
                }
                hideLoader();
                return;
            }

            // Guest Order Modal
            if (target.id === 'close-guest-order-modal-btn' || (target === elements.guestOrderModal && e.target === elements.guestOrderModal)) {
                elements.guestOrderModal.classList.add('hidden');
                return;
            }

            if (target.id === 'save-guest-order-btn') {
                showLoader();
                try {
                    const guestName = document.getElementById('guest-name-input').value.trim();
                    const guestDepart = document.getElementById('guest-depart-input').value.trim();
                    const guestShift = document.querySelector('input[name="guest-shift"]:checked').value;
                    const guestWeek = document.querySelector('input[name="guest-week"]:checked').value;
                    
                    if (!guestName || !guestDepart) {
                        showToast('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin', 'error');
                        hideLoader();
                        return;
                    }
                    
                    const selectedDays = Object.keys(state.guestOrderSelection).filter(day => state.guestOrderSelection[day]);
                    
                    if (selectedDays.length === 0) {
                        showToast('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt ng√†y', 'error');
                        hideLoader();
                        return;
                    }
                    
                    const today = new Date();
                    const targetWeek = guestWeek === 'next' 
                        ? getWeekString(new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000))
                        : getWeekString(today);
                    
                    const guestKey = `guest_${Date.now()}`;
                    
                    for (const dayKey of selectedDays) {
                        const dish = state.guestOrderSelection[dayKey];
                        if (!dish) continue;
                        
                        const dayDocRef = doc(db, targetWeek, dayKey);
                        const updatePayload = {
                            [guestKey]: {
                                name: guestName,
                                email: `guest_${Date.now()}@temp.com`,
                                food: dish,
                                status: 'not',
                                shift: guestShift,
                                depart: guestDepart,
                            }
                        };
                        await setDoc(dayDocRef, updatePayload, { merge: true });
                        state.cachedData.delete(`${targetWeek}/${dayKey}`);
                    }
                    
                    showToast('ƒê·∫∑t m√≥n cho kh√°ch th√†nh c√¥ng!');
                    elements.guestOrderModal.classList.add('hidden');
                    state.guestOrderSelection = {};
                    await renderAdminSupport();
                } catch (error) {
                    showToast('C√≥ l·ªói x·∫£y ra', 'error');
                    console.error(error);
                }
                hideLoader();
                return;
            }

            // Guest order dish selection
            if (target.classList.contains('guest-dish-item')) {
                const dayKey = target.dataset.dayKey;
                const dish = target.dataset.dish;
                
                state.guestOrderSelection[dayKey] = dish;
                
                document.querySelectorAll(`[data-day-key="${dayKey}"].guest-dish-item`).forEach(item => {
                    item.classList.remove('selected');
                });
                target.classList.add('selected');
                return;
            }
        });

        async function renderGuestOrderDays(weekType) {
            const today = new Date();
            const targetWeek = weekType === 'next' 
                ? getWeekString(new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000))
                : getWeekString(today);
            
            const menu = await getDocument(targetWeek, "menu");
            if (!menu) {
                document.getElementById('guest-order-days-container').innerHTML = `
                    <p class="text-center" style="color: var(--text-muted); margin: 1rem 0;">Ch∆∞a c√≥ th·ª±c ƒë∆°n</p>
                `;
                return;
            }
            
            const days = { mon: "Th·ª© 2", tue: "Th·ª© 3", wed: "Th·ª© 4", thu: "Th·ª© 5", fri: "Th·ª© 6" };
            let html = '';
            
            for (const [dayKey, dayName] of Object.entries(days)) {
                const dishes = menu[dayKey] || [];
                if (!Array.isArray(dishes) || dishes.length === 0) continue;
                
                html += `
                    <div class="order-day-card">
                        <div class="order-day-header">
                            <div class="order-day-title">${dayName}</div>
                        </div>
                        <div class="order-dish-list">
                            ${dishes.map((dish, index) => `
                                <div class="order-dish-item guest-dish-item ${state.guestOrderSelection[dayKey] === dish ? 'selected' : ''}" 
                                     data-dish="${dish}" data-day-key="${dayKey}">
                                    <div class="order-dish-icon">${getFoodIcon(index)}</div>
                                    <div class="order-dish-name">${parseDish(dish)}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('guest-order-days-container').innerHTML = html;
        }

        // Check Order Notification
        async function checkOrderNotification() {
            if (!elements.tabBar.querySelector('.nav-item[data-tab="order"]') || !state.currentUser) return;
            
            const orderTab = elements.tabBar.querySelector('.nav-item[data-tab="order"]');
            const today = new Date();
            const dayOfWeek = today.getDay();
            
            if (dayOfWeek >= 4 || dayOfWeek === 0) {
                const nextWeek = getWeekString(new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000));
                const nextWeekOrders = await getDocument(nextWeek, 'mon');
                orderTab.classList.toggle('needs-attention', !nextWeekOrders || !nextWeekOrders[emailToKey(state.currentUser.email)]);
            } else {
                orderTab.classList.remove('needs-attention');
            }
        }

        // Main App Initialization
        async function main() {
            showLoader();
            try {
                await setPersistence(auth, browserLocalPersistence);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user && user.uid !== state.currentUser?.uid) {
                        try {
                            state.currentUser = user;
                            state.authReady = true;
                            await syncUserProfile();
                            await checkOrderNotification();
                            updateUIForUser(user);
                            
                            // Auto switch to order tab on Thu/Fri
                            const today = new Date();
                            const dayOfWeek = today.getDay();
                            if (dayOfWeek === 4 || dayOfWeek === 5) {
                                state.currentTab = 'order';
                                document.querySelectorAll('.nav-item').forEach(item => {
                                    item.classList.toggle('active', item.dataset.tab === 'order');
                                });
                            }
                            
                            await render();
                            showToast(`Ch√†o m·ª´ng, ${getFirstName(state.staffProfile.name)}!`);
                        } catch (authError) {
                            showToast(authError.message, 'error');
                            await signOut(auth);
                        }
                    } else if (!user) {
                        state.currentUser = null;
                        state.isAdmin = false;
                        state.authReady = true;
                        updateUIForUser(null);
                    }
                    hideLoader();
                });
            } catch (error) {
                console.error('App init error:', error);
                hideLoader();
                showToast('Kh√¥ng th·ªÉ kh·ªüi t·∫°o ·ª©ng d·ª•ng', 'error');
            }
        }

        main();
    </script>
</body>
</html>
